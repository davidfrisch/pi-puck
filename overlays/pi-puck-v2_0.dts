/dts-v1/;
/plugin/;

/ {
	compatible = "brcm,bcm2708";

	/* System LEDs */
	fragment@0 {
		target = <&leds>;
		__overlay__ {
			compatible = "gpio-leds";
			/* pipuck_sd {
				label = "pipuck_sd";
				gpios = <&gpio 7 GPIO_ACTIVE_LOW>; // GP_LED1
				linux,default-trigger = "mmc0";
			}; */
			pipuck_wrx {
				label = "pipuck_wrx";
				gpios = <&gpio 21 1>; // GP_LED5
				linux,default-trigger = "phy0rx";
			};
			pipuck_wtx {
				label = "pipuck_wtx";
				gpios = <&gpio 20 1>; // GP_LED4
				linux,default-trigger = "phy0tx";
			};
			pipuck_boot {
				label = "pipuck_boot";
				gpios = <&gpio 16 1>; // GP_LED3
				linux,default-trigger = "heartbeat";
			};
			pipuck_user {
				label = "pipuck_user";
				gpios = <&gpio 12 1>; // GP_LED2
				linux,default-trigger = "mmc0"; // Workaround for GP_LED1 not being connected
			};
		};
	};

	/* Control switch keys */
	fragment@1 {
		target-path = "/soc";
		__dormant__ {
			control-switches {
				compatible = "gpio-keys";
				pipuck_switch1 {
					label = "pipuck_switch1";
					gpios = <&gpio 26 0>; // SW1
					linux,code = <256>;
				};
			};
		};
	};
	fragment@2 {
		target-path = "/soc";
		__dormant__ {
			control-switches {
				compatible = "gpio-keys";
				pipuck_switch2 {
					label = "pipuck_switch2";
					gpios = <&gpio 19 0>; // SW2
					linux,code = <257>;
				};
				pipuck_switch3 {
					label = "pipuck_switch3";
					gpios = <&gpio 13 0>; // SW3
					linux,code = <258>;
				};
				pipuck_switch4 {
					label = "pipuck_switch4";
					gpios = <&gpio 17 0>; // SW4
					linux,code = <259>;
				};
			};
		};
	};

	/* Control switch power key */
	fragment@3 {
		target-path = "/soc";
		__dormant__ {
			control-switches {
				compatible = "gpio-keys";
				pipuck_switch1 {
					label = "shutdown";
					linux,code = <116>; // KEY_POWER
					gpios = <&gpio 26 0>;
				};

			};
		};
	};

	/* Audio output */
	fragment@4 {
		target = <&gpio>;
		__overlay__ {
			pwm_pins: pwm_pins {
				brcm,pins = <18>;
				brcm,function = <2>; // Alt5
			};
		};
	};
	fragment@5 {
		target = <&pwm>;
		__overlay__ {
			pinctrl-names = "default";
			pinctrl-0 = <&pwm_pins>;
			status = "okay";
		};
	};

	/* I2C devices */
	fragment@6 {
		target = <&i2c1>;
		__overlay__ {
			#address-cells = <1>;
			#size-cells = <0>;
			status = "okay";
			clock-frequency = <400000>;
			i2c-switch@70 {
				compatible = "nxp,pca9544";
				#address-cells = <1>;
				#size-cells = <0>;
				reg = <0x70>;
				i2c@0 {
					#address-cells = <1>;
					#size-cells = <0>;
					reg = <0>;
					pipuck_gpiouser: gpio@20 {
						compatible = "microchip,mcp23008";
						gpio-controller;
						#gpio-cells = <2>;
						reg = <0x20>;
					};
					pipuck_gpionav: gpio@21 {
						compatible = "microchip,mcp23008";
						gpio-controller;
						#gpio-cells = <2>;
						reg = <0x21>;
					};
					pipuck_adc: ads1015@48 {
						compatible = "ti,ads1015";
						reg = <0x48>;
						#address-cells = <1>;
						#size-cells = <0>;
						pipuck_ain0: channel@4 {
							reg = <4>;
							ti,gain = <0>;
							ti,datarate = <0>;
						};
						pipuck_ain1: channel@5 {
							reg = <5>;
							ti,gain = <0>;
							ti,datarate = <0>;
						};
					};
					/* OLED 0x3c */
				};
				i2c@1 {
					#address-cells = <1>;
					#size-cells = <0>;
					reg = <1>;
					/* e-puck */
				};
				i2c@2 {
					#address-cells = <1>;
					#size-cells = <0>;
					reg = <2>;
					/* Left LIDAR 0x29 */
				};
				i2c@3 {
					#address-cells = <1>;
					#size-cells = <0>;
					reg = <3>;
					/* Right LIDAR 0x29 */
				};
			};
		};
	};

	/* User LEDs */
	fragment@7 {
		target = <&leds>;
		__overlay__ {
			compatible = "gpio-leds";
			pipuck_led1 {
				label = "pipuck_led1";
				gpios = <&pipuck_gpiouser 7 0>; // LED14
			};
			pipuck_led2 {
				label = "pipuck_led2";
				gpios = <&pipuck_gpiouser 6 0>; // LED13
			};
			pipuck_led3 {
				label = "pipuck_led3";
				gpios = <&pipuck_gpiouser 5 0>; // LED11
			};
			pipuck_led4 {
				label = "pipuck_led4";
				gpios = <&pipuck_gpiouser 4 0>; // LED12
			};
		};
	};

	/* Nav LED */
	fragment@8 {
		target = <&leds>;
		__overlay__ {
			compatible = "gpio-leds";
			pipuck_nav {
				label = "pipuck_nav";
				gpios = <&pipuck_gpionav 7 0>; // LED9
			};
		};
	};

	/* Disable Bluetooth to free up UART */
	fragment@9 {
		target = <&uart1>;
		__dormant__ {
			status = "disabled";
		};
	};
	fragment@10 {
		target = <&uart0>;
		__dormant__ {
			pinctrl-names = "default";
			pinctrl-0 = <&uart0_pins>;
			status = "okay";
		};
	};
	fragment@11 {
		target = <&uart0_pins>;
		__dormant__ {
			brcm,pins;
			brcm,function;
			brcm,pull;
		};
	};
	fragment@12 {
		target-path = "/aliases";
		__dormant__ {
			serial0 = "/soc/serial@7e201000";
			serial1 = "/soc/serial@7e215040";
		};
	};

	/* Enable external ADC channels */
	fragment@13 {
		target = <&pipuck_adc>;
		__dormant__ {
			#address-cells = <1>;
			#size-cells = <0>;
			pipuck_ain2: channel@6 {
				reg = <6>;
				ti,gain = <2>;
				ti,datarate = <4>;
			};
		};
	};
	fragment@14 {
		target = <&pipuck_adc>;
		__dormant__ {
			#address-cells = <1>;
			#size-cells = <0>;
			pipuck_ain3: channel@7 {
				reg = <7>;
				ti,gain = <2>;
				ti,datarate = <4>;
			};
		};
	};

	__overrides__ {
		control_keys = <0>,"+1+2-3";
		power_key = <0>,"-1+3";
		uart = <0>,"+9+10+11+12";
		ain2 = <0>,"+13";
		ain2_gain = <&pipuck_ain2>,"ti,gain:0";
		ain2_datarate = <&pipuck_ain2>,"ti,datarate:0";
		ain3 = <0>,"+14";
		ain3_gain = <&pipuck_ain3>,"ti,gain:0";
		ain3_datarate = <&pipuck_ain3>,"ti,datarate:0";
	};
};
